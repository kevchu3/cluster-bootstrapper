---

- name: Bootstrap OpenShift
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - community.okd

  vars:
    openshift_api_url: "{{ lookup('ansible.builtin.env', 'OPENSHIFT_API_URL') }}"
    openshift_token: "{{ lookup('ansible.builtin.env', 'OPENSHIFT_TOKEN') }}"
    openshift_validate_certs: false
  vars_files:
    - vars.yaml

      ## vars.yaml should include the following in this example
      # root_vault:
      #   client_id: "<client_id>"
      #   client_secret: "<client_secret>"
      #   tenant_id: "<tenant_id>"
      #   vault_url: "<vault_url>"

  tasks:

    - name: Ensure GitOps Namespace
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: present
        src: "manifests/gitops/namespace.yaml"

    - name: Ensure ARGOCD Subscription
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: present
        src: "manifests/gitops/subscription.yaml"

    - name: Ensure Creator RBAC
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: present
        src: "manifests/gitops/rbac.yaml"

    - name: Ensure External Secrets Subscription
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: present
        src: "manifests/external-secrets/subscription.yaml"

    - name: Ensure External Secrets Operator
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: present
        src: "manifests/external-secrets/operator.yaml"

    - name: Ensure Azure Key Vault Secret
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: present
        definition:
          apiVersion: v1
          data:
            client-id: "{{ root_vault.client_id | b64encode }}"
            client-secret: "{{ root_vault.client_secret | b64encode }}"
          kind: Secret
          metadata:
            name: azure-eso-secret
            namespace: openshift-operators

    - name: Ensure External - Secrets Cluster Secret Store
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: present
        definition:
          apiVersion: external-secrets.io/v1alpha1
          kind: ClusterSecretStore
          metadata:
            name: eso-secret-store
            namespace: openshift-operators
          spec:
            provider:
              azurekv:
                tenantId: "{{ root_vault.tenant_id }}"
                vaultUrl: "{{ root_vault.vault_url }}"
                authSecretRef:
                  clientId:
                    name: azure-eso-secret
                    namespace: openshift-operators
                    key: client-id
                  clientSecret:
                    name: azure-eso-secret
                    namespace: openshift-operators
                    key: client-secret

    - name: Ensure Test Secret 
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: absent
        src: "manifests/external-secrets/test.yaml"

    - name: Ensure Repository Connection 
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: present
        src: "manifests/gitops/repo-connection.yaml"

    - name: Ensure Root App-of-Apps Configuration 
      community.okd.k8s:
        host: "{{ openshift_api_url }}"
        api_key: "{{ openshift_token }}"
        validate_certs: "{{ openshift_validate_certs }}"
        state: present
        src: "manifests/gitops/root-app.yaml"
